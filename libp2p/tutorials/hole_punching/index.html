<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Hole Punching Tutorial"><meta name="keywords" content="rust, rustlang, rust-lang, hole_punching"><title>libp2p::tutorials::hole_punching - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script src="../../../crates.js"></script><script defer src="../../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="shortcut icon" href="https:&#x2F;&#x2F;libp2p.io&#x2F;img&#x2F;favicon.png"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a class="sidebar-logo" href="../../../libp2p/index.html"><div class="logo-container"><img src="https:&#x2F;&#x2F;libp2p.io&#x2F;img&#x2F;logo_small.png" alt="logo"></div>
        </a><h2 class="location">Module hole_punching</h2><div class="sidebar-elems"><div id="sidebar-vars" data-name="hole_punching" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../libp2p/index.html"><img src="https:&#x2F;&#x2F;libp2p.io&#x2F;img&#x2F;logo_small.png" alt="logo"></a><nav class="sub"><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="18" height="18" alt="Pick another theme!" src="../../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../../settings.html" title="settings"><img width="18" height="18" alt="Change settings" src="../../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">libp2p</a>::<wbr><a href="../index.html">tutorials</a>::<wbr><a class="mod" href="#">hole_punching</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../../../src/libp2p/tutorials/hole_punching.rs.html#21-150" title="goto source code">[src]</a></span></h1><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="hole-punching-tutorial" class="section-header"><a href="#hole-punching-tutorial">Hole Punching Tutorial</a></h2>
<p>This tutorial shows hands-on how to overcome firewalls and NATs with libp2p’s hole punching
mechanism. Before we get started, please read the <a href="https://blog.ipfs.io/2022-01-20-libp2p-hole-punching/">blog
post</a> to familiarize yourself with libp2p’s hole
punching mechanism on a conceptual level.</p>
<p>We will be using the <a href="../../relay/v2/index.html">Circuit Relay v2</a> and the <a href="crate::dcutr">Direct Connection
Upgrade through Relay (DCUtR)</a> protocol.</p>
<p>You will need 3 machines for this tutorial:</p>
<ul>
<li>A relay server:
<ul>
<li>Any public server will do, e.g. a cloud provider VM.</li>
</ul>
</li>
<li>A listening client:
<ul>
<li>Any computer connected to the internet, but not reachable from outside its own network,
works.</li>
<li>This can e.g. be your friends laptop behind their router (firewall + NAT).</li>
<li>This can e.g. be some cloud provider VM, shielded from incoming connections e.g. via
Linux’s UFW on the same machine.</li>
<li>Don’t use a machine that is in the same network as the dialing client. (This would require
NAT hairpinning.)</li>
</ul>
</li>
<li>A dialing client:
<ul>
<li>Like the above, any computer connected to the internet, but not reachable from the outside.</li>
<li>Your local machine will likely fulfill these requirements.</li>
</ul>
</li>
</ul>
<h3 id="setting-up-the-relay-server" class="section-header"><a href="#setting-up-the-relay-server">Setting up the relay server</a></h3>
<p>Hole punching requires a public relay node for the two private nodes to coordinate their hole
punch via. For that we need a public server somewhere in the Internet. In case you don’t have
one already, any cloud provider VM will do.</p>
<p>Either on the server directly, or on your local machine, compile the example relay server:</p>
<div class="example-wrap"><pre class="language-bash"><code># Inside the rust-libp2p repository.
cargo build --example relay_v2 -p libp2p-relay</code></pre></div>
<p>You can find the binary at <code>target/debug/examples/relay_v2</code>. In case you built it locally, copy
it to your server.</p>
<p>On your server, start the relay server binary:</p>
<div class="example-wrap"><pre class="language-bash"><code>./relay_v2 --port 4001 --secret-key-seed 0</code></pre></div>
<p>Now let’s make sure that the server is public, in other words let’s make sure one can reach it
through the Internet. From the dialing client:</p>
<ol>
<li>
<p>Test that you can connect on Layer 3 (IP).</p>
<div class="example-wrap"><pre class="language-bash"><code>ping $RELAY_SERVER_IP</code></pre></div></li>
<li>
<p>Test that you can connect on Layer 4 (TCP).</p>
<div class="example-wrap"><pre class="language-bash"><code>telnet $RELAY_SERVER_IP 4001</code></pre></div></li>
<li>
<p>Test that you can connect via libp2p using <a href="https://github.com/mxinden/libp2p-lookup"><code>libp2p-lookup</code></a>.</p>
<div class="example-wrap"><pre class="language-bash"><code># For IPv4
libp2p-lookup direct --address /ip4/$RELAY_SERVER_IP
# For IPv6
libp2p-lookup direct --address /ip6/$RELAY_SERVER_IP</code></pre></div></li>
</ol>
<h3 id="setting-up-the-listening-client" class="section-header"><a href="#setting-up-the-listening-client">Setting up the listening client</a></h3>
<p>Either on the listening client machine directly, or on your local machine, compile the example
DCUtR client:</p>
<div class="example-wrap"><pre class="language-bash"><code># Inside the rust-libp2p repository.
cargo build --example client -p libp2p-dcutr</code></pre></div>
<p>You can find the binary at <code>target/debug/examples/client</code>. In case you built it locally, copy
it to your listening client machine.</p>
<p>On the listening client machine:</p>
<div class="example-wrap"><pre class="language-bash"><code>RUST_LOG=info ./client --secret-key-seed 1 --mode listen --relay-address /ip4/$RELAY_SERVER_IP/tcp/4001/p2p/12D3KooWDpJ7As7BWAwRMfu1VU2WCqNjvq387JEYKDBj4kx6nXTN</code></pre></div>
<p>Now let’s make sure that the listening client is not public, in other words let’s make sure one
can not reach it directly through the Internet. From the dialing client test that you can not
connect on Layer 4 (TCP):</p>
<div class="example-wrap"><pre class="language-bash"><code>telnet $RELAY_SERVER_IP 4001</code></pre></div><h3 id="connecting-to-the-listening-client-from-the-dialing-client" class="section-header"><a href="#connecting-to-the-listening-client-from-the-dialing-client">Connecting to the listening client from the dialing client</a></h3><div class="example-wrap"><pre class="language-bash"><code>RUST_LOG=info ./client --secret-key-seed 2 --mode dial --relay-address /ip4/$RELAY_SERVER_IP/tcp/4001/p2p/12D3KooWDpJ7As7BWAwRMfu1VU2WCqNjvq387JEYKDBj4kx6nXTN --remote-peer-id 12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X</code></pre></div>
<p>You should see the following logs appear:</p>
<ol>
<li>
<p>The dialing client establishing a relayed connection to the listening client via the relay
server. Note the <a href="../../core/multiaddr/enum.Protocol.html#variant.P2pCircuit"><code>/p2p-circuit</code> protocol</a> in the
<a href="../../struct.Multiaddr.html"><code>Multiaddr</code></a>.</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code>[<span class="number">2022</span><span class="op">-</span><span class="number">01</span><span class="op">-</span><span class="number">30T12</span>:<span class="number">54</span>:<span class="number">10Z</span> <span class="ident">INFO</span>  <span class="ident">client</span>] <span class="ident">Established</span> <span class="ident">connection</span> <span class="ident">to</span> <span class="ident">PeerId</span>(<span class="string">&quot;12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X&quot;</span>) <span class="ident">via</span> <span class="ident">Dialer</span> { <span class="ident">address</span>: <span class="string">&quot;/ip4/$RELAY_PEER_ID/tcp/4001/p2p/12D3KooWDpJ7As7BWAwRMfu1VU2WCqNjvq387JEYKDBj4kx6nXTN/p2p-circuit/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X&quot;</span>, <span class="ident">role_override</span>: <span class="ident">Dialer</span> }</code></pre></div>
</li>
<li>
<p>The listening client initiating a direct connection upgrade for the new relayed connection.
Reported by <a href="crate::dcutr"><code>dcutr</code></a> through
<a href="crate::dcutr::behaviour::Event::RemoteInitiatedDirectConnectionUpgrade"><code>Event::RemoteInitiatedDirectConnectionUpgrade</code></a>.</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code>[<span class="number">2022</span><span class="op">-</span><span class="number">01</span><span class="op">-</span><span class="number">30T12</span>:<span class="number">54</span>:<span class="number">11Z</span> <span class="ident">INFO</span>  <span class="ident">client</span>] <span class="ident">RemoteInitiatedDirectConnectionUpgrade</span> { <span class="ident">remote_peer_id</span>: <span class="ident">PeerId</span>(<span class="string">&quot;12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X&quot;</span>), <span class="ident">remote_relayed_addr</span>: <span class="string">&quot;/ip4/$RELAY_PEER_ID/tcp/4001/p2p/12D3KooWDpJ7As7BWAwRMfu1VU2WCqNjvq387JEYKDBj4kx6nXTN/p2p-circuit/p2p/12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X&quot;</span> }</code></pre></div>
</li>
<li>
<p>The direct connection upgrade, also known as hole punch, succeeding. Reported by
<a href="crate::dcutr"><code>dcutr</code></a> through
<a href="crate::dcutr::behaviour::Event::DirectConnectionUpgradeSucceeded"><code>Event::RemoteInitiatedDirectConnectionUpgrade</code></a>.</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code>[<span class="number">2022</span><span class="op">-</span><span class="number">01</span><span class="op">-</span><span class="number">30T12</span>:<span class="number">54</span>:<span class="number">11Z</span> <span class="ident">INFO</span>  <span class="ident">client</span>] <span class="ident">DirectConnectionUpgradeSucceeded</span> { <span class="ident">remote_peer_id</span>: <span class="ident">PeerId</span>(<span class="string">&quot;12D3KooWPjceQrSwdWXPyLLeABRXmuqt69Rg3sBYbU1Nft9HyQ6X&quot;</span>) }</code></pre></div>
</li>
</ol>
</div></details></section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="libp2p" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.59.0 (9d1b2106e 2022-02-23)" ></div>
</body></html>